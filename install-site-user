#!/usr/bin/env bash

INSTALL_ERROR_LOG="/var/log/install-script-errors.log"

SETUP_ERRORS=()

if [ -z "$SITE_USER" ]; then
  SETUP_ERRORS+="SITE_USER variable is required."
fi

if [ -z "$SITE_USER_RSA_PRIV_KEY_VALUE" ]; then
  SETUP_ERRORS+="SITE_USER_RSA_PRIV_KEY_VALUE variable is required."
fi

if [ -z "$SITE_USER_RSA_PUB_KEY_VALUE" ]; then
  SETUP_ERRORS+="SITE_USER_RSA_PUB_KEY_VALUE variable is required."
fi

if [ "${#SETUP_ERRORS[*]}" -gt 0 ]; then
  touch "$INSTALL_ERROR_LOG"

  LOG_TIME="$(date '+%m-%d-%Y %T')"

  for SETUP_ERROR in "${SETUP_ERRORS[@]}"
  do
    echo "[$LOG_TIME] $SETUP_ERROR" >> "$INSTALL_ERROR_LOG"

    printf "\n%s\n" "Error(s) on installation. See $INSTALL_ERROR_LOG for details."
  done

  exit 1
fi

# See https://unix.stackexchange.com/a/210232

SITE_USER_RSA_PRIV_KEY_VALUE="$2"
SITE_USER_RSA_PUB_KEY_VALUE="$3"

SITE_USER_HOME="/home/$SITE_USER"
SITE_USER_SSH_DIR="$SITE_USER_HOME/.ssh"
SITE_USER_RSA_PRIV_KEY="$SITE_USER_SSH_DIR/id_rsa"
SITE_USER_RSA_PUB_KEY="$SITE_USER_RSA_PRIV_KEY.pub"

KNOWN_HOSTS="$SITE_USER_SSH_DIR/known_hosts"
AUTHORIZED_KEYS="$SITE_USER_SSH_DIR/authorized_keys"

useradd -m -d "$SITE_USER_HOME" -s /bin/bash "$SITE_USER"

mkdir "$SITE_USER_SSH_DIR"
touch "$AUTHORIZED_KEYS"
touch "$KNOWN_HOSTS"

GITHUB_KEY_HOST="github.com ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAq2A7hRGmdnm9tUDbO9IDSwBK6TbQa+PXYPCPy6rbTrTtw7PHkccKrpp0yVhp5HdEIcKr6pLlVDBfOLX9QUsyCOV0wzfjIJNlGEYsdlLJizHhbn2mUjvSAHQqZETYP81eFzLQNnPHt4EVVUh7VfDESU84KezmD5QlWpXLmvU31/yMf+Se8xhHTvKSCZIFImWwoG6mbUoWf9nzpIoaSjB+weqqUUmpaaasXVal72J+UX2B+2RPW3RcT0eOzQgqlJL3RKrTJvdsjE3JEAvGq3lGHSZXy28G3skua2SmVi/w4yCE6gbODqnTWlg7+wC604ydGXA8VJiS5ap43JXiUFFAaQ=="
GITHUB_KEY_IPS[0]="140.82.114.3 ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAq2A7hRGmdnm9tUDbO9IDSwBK6TbQa+PXYPCPy6rbTrTtw7PHkccKrpp0yVhp5HdEIcKr6pLlVDBfOLX9QUsyCOV0wzfjIJNlGEYsdlLJizHhbn2mUjvSAHQqZETYP81eFzLQNnPHt4EVVUh7VfDESU84KezmD5QlWpXLmvU31/yMf+Se8xhHTvKSCZIFImWwoG6mbUoWf9nzpIoaSjB+weqqUUmpaaasXVal72J+UX2B+2RPW3RcT0eOzQgqlJL3RKrTJvdsjE3JEAvGq3lGHSZXy28G3skua2SmVi/w4yCE6gbODqnTWlg7+wC604ydGXA8VJiS5ap43JXiUFFAaQ=="
GITHUB_KEY_IPS[1]="140.82.112.3 ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAq2A7hRGmdnm9tUDbO9IDSwBK6TbQa+PXYPCPy6rbTrTtw7PHkccKrpp0yVhp5HdEIcKr6pLlVDBfOLX9QUsyCOV0wzfjIJNlGEYsdlLJizHhbn2mUjvSAHQqZETYP81eFzLQNnPHt4EVVUh7VfDESU84KezmD5QlWpXLmvU31/yMf+Se8xhHTvKSCZIFImWwoG6mbUoWf9nzpIoaSjB+weqqUUmpaaasXVal72J+UX2B+2RPW3RcT0eOzQgqlJL3RKrTJvdsjE3JEAvGq3lGHSZXy28G3skua2SmVi/w4yCE6gbODqnTWlg7+wC604ydGXA8VJiS5ap43JXiUFFAaQ=="
GITHUB_KEY_IPS[2]="140.82.112.4 ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAq2A7hRGmdnm9tUDbO9IDSwBK6TbQa+PXYPCPy6rbTrTtw7PHkccKrpp0yVhp5HdEIcKr6pLlVDBfOLX9QUsyCOV0wzfjIJNlGEYsdlLJizHhbn2mUjvSAHQqZETYP81eFzLQNnPHt4EVVUh7VfDESU84KezmD5QlWpXLmvU31/yMf+Se8xhHTvKSCZIFImWwoG6mbUoWf9nzpIoaSjB+weqqUUmpaaasXVal72J+UX2B+2RPW3RcT0eOzQgqlJL3RKrTJvdsjE3JEAvGq3lGHSZXy28G3skua2SmVi/w4yCE6gbODqnTWlg7+wC604ydGXA8VJiS5ap43JXiUFFAaQ=="
GITHUB_KEY_IPS[3]="140.82.113.3 ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAq2A7hRGmdnm9tUDbO9IDSwBK6TbQa+PXYPCPy6rbTrTtw7PHkccKrpp0yVhp5HdEIcKr6pLlVDBfOLX9QUsyCOV0wzfjIJNlGEYsdlLJizHhbn2mUjvSAHQqZETYP81eFzLQNnPHt4EVVUh7VfDESU84KezmD5QlWpXLmvU31/yMf+Se8xhHTvKSCZIFImWwoG6mbUoWf9nzpIoaSjB+weqqUUmpaaasXVal72J+UX2B+2RPW3RcT0eOzQgqlJL3RKrTJvdsjE3JEAvGq3lGHSZXy28G3skua2SmVi/w4yCE6gbODqnTWlg7+wC604ydGXA8VJiS5ap43JXiUFFAaQ=="
GITHUB_KEY_IPS[4]="140.82.113.4 ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAq2A7hRGmdnm9tUDbO9IDSwBK6TbQa+PXYPCPy6rbTrTtw7PHkccKrpp0yVhp5HdEIcKr6pLlVDBfOLX9QUsyCOV0wzfjIJNlGEYsdlLJizHhbn2mUjvSAHQqZETYP81eFzLQNnPHt4EVVUh7VfDESU84KezmD5QlWpXLmvU31/yMf+Se8xhHTvKSCZIFImWwoG6mbUoWf9nzpIoaSjB+weqqUUmpaaasXVal72J+UX2B+2RPW3RcT0eOzQgqlJL3RKrTJvdsjE3JEAvGq3lGHSZXy28G3skua2SmVi/w4yCE6gbODqnTWlg7+wC604ydGXA8VJiS5ap43JXiUFFAaQ=="
GITHUB_KEY_IPS[5]="140.82.114.4 ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAq2A7hRGmdnm9tUDbO9IDSwBK6TbQa+PXYPCPy6rbTrTtw7PHkccKrpp0yVhp5HdEIcKr6pLlVDBfOLX9QUsyCOV0wzfjIJNlGEYsdlLJizHhbn2mUjvSAHQqZETYP81eFzLQNnPHt4EVVUh7VfDESU84KezmD5QlWpXLmvU31/yMf+Se8xhHTvKSCZIFImWwoG6mbUoWf9nzpIoaSjB+weqqUUmpaaasXVal72J+UX2B+2RPW3RcT0eOzQgqlJL3RKrTJvdsjE3JEAvGq3lGHSZXy28G3skua2SmVi/w4yCE6gbODqnTWlg7+wC604ydGXA8VJiS5ap43JXiUFFAaQ=="

echo "$GITHUB_KEY_HOST" >> "$KNOWN_HOSTS"

for GITHUB_KEY_IP in "${GITHUB_KEY_IPS[@]}"
do
    echo "$GITHUB_KEY_IP" >> "$KNOWN_HOSTS"
done

ASSEMBLA_KEY_HOSTS[0]="git.assembla.com ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAr06hg4ep5IKc85rjYZkEmer+BMkpLfsYi7iOMWytiqyow0jqMiVg7t32a4WW0349QV4rmfcMg5ULuIP//mBjSb2G1jSmqPvWx4JCzZLKu3nmsx1YdBWmVvn/qyVLQ5E+NCSkJJORKqIIgiL1WuAEaxUODYmBExwv1eMZWBpyeKZrrsBEmogKt2Q+igQ31+rb1fQI9/hDE+SktOpT9sWJ9brSDgsQNXAtV52DFDA8mzq7FL+4TbLjDoDdK7v3LFYn2cnN2kD57gW8qvP6V6mrkjc6I2aCNBHwdcIynUQ8HKdU+Sd4u7pZsCCK7odgPCcM5Jj+/PladSR8+DCtvs6JWw=="
ASSEMBLA_KEY_HOSTS[1]="git.assembla.com ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBCgF2nbN5k2W4gUAkyE7+iI5T5Ng2f5xiL4+gGkARwRhftogPzqYi3+IM4PZnDW6nKPzWGo+b+mx2LR4FO0+2IE="

for ASSEMBLA_KEY_HOST in "${ASSEMBLA_KEY_HOSTS[@]}"
do
    echo "$ASSEMBLA_KEY_HOST" >> "$KNOWN_HOSTS"
done

echo "$SITE_USER_RSA_PRIV_KEY_VALUE" > "$SITE_USER_RSA_PRIV_KEY"
echo "$SITE_USER_RSA_PUB_KEY_VALUE" > "$SITE_USER_RSA_PUB_KEY"

chmod 0600 "$SITE_USER_RSA_PRIV_KEY"

eval $(ssh-agent -s)
ssh-add "$SITE_USER_RSA_PRIV_KEY"

chown -R "$SITE_USER:$SITE_USER" "$SITE_USER_SSH_DIR"
chmod 700 "$SITE_USER_SSH_DIR"
chmod 600 "$SITE_USER_SSH_DIR/known_hosts"
chmod 600 "$SITE_USER_SSH_DIR/authorized_keys"
chmod go-w "$SITE_USER_HOME"

usermod -aG www-data "$SITE_USER"
usermod -aG docker "$SITE_USER"
usermod -aG sudo "$SITE_USER"

echo "$SITE_USER ALL=(ALL:ALL) NOPASSWD: ALL" | sudo tee "/etc/sudoers.d/$SITE_USER"

service sshd restart
